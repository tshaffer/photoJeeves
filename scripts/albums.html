<html>

<head>
  <style>
    .selected {
      color: red;
    }

    #bodyId {
      background-color: #d3d3d3;
      margin-top: 32px;
      margin-left: 48px;
    }

    #albums {
      font-size: 24px;
      font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
      border-collapse: collapse;
      width: 98%;
    }

    #albums td,
    #albums th {
      border: 1px solid #ddd;
      padding: 8px;
    }

    #albums tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #albums tr:hover {
      background-color: #ddd;
    }

    #albums th {
      padding-top: 12px;
      padding-bottom: 12px;
      text-align: left;
      background-color: #4CAF50;
      color: white;
    }
  </style>
</head>

<body id="bodyId" onload="pageLoaded()">
  <h1 style="color:white">Photo Jeeves albums</h1>
  <table id="albums">
  </table>
</body>

<script type="text/javascript">

  console.log('eat pizza');

  const albumsData = require('/storage/sd/albumsManifest.json');
  const albums = albumsData.ALBUM_SPECS;

  var bsMessagePort = new BSMessagePort();

  var highlightedRow = 0;
  var highlightedColumn = 0;
  const numColumnsPerRow = 3;

  bsMessagePort.onbsmessage = function (msg) {

    console.log("bsMessage.onbsmessage - entry");
    console.log(msg.data.remoteevent);
    console.log(Object.keys(msg.data));

    if (msg.data.hasOwnProperty('remoteevent')) {
      onRemoteEvent(msg.data['remoteevent']);
    }
  }

  function onRemoteEvent(remoteEvent) {

    switch (remoteEvent) {
      case 'HOME':
        bsMessagePort.PostBSMessage({ event: 'showAlbumList' });
        return;
      case 'PAUSE':
        bsMessagePort.PostBSMessage({ event: 'pausePlayback' });
        return;
      case 'PLAY':
        bsMessagePort.PostBSMessage({ event: 'startPlayback' });
        return;
      case 'SEL':
        const selectedAlbumIndex = (highlightedRow * numColumnsPerRow) + highlightedColumn;
        const selectedAlbumSpec = albumsData.ALBUM_SPECS[selectedAlbumIndex];
        const event = 'playAlbum';

        console.log('selectedAlbumSpec');
        console.log(selectedAlbumSpec);

        const payload = selectedAlbumSpec.title.toLowerCase();

        console.log('payload');
        console.log(payload);
        console.log('String(payload)');
        console.log(String(payload));

        bsMessagePort.PostBSMessage({ event: event, payload: String(payload) })
        return;
        break;
      case 'WEST':
        highlightedColumn--;
        break;
      case 'EAST':
        highlightedColumn++;
        break;
      case 'NORTH':
        highlightedRow = highlightedRow - 1;
        break;
      case 'SOUTH':
        highlightedRow = highlightedRow + 1;
        break;
    }

    var table = document.getElementById('albums');
    var allRows = table.getElementsByTagName('tr');
    var numberOfRows = allRows.length;

    if (highlightedColumn >= numColumnsPerRow) {
      highlightedColumn = numColumnsPerRow - 1;
    }
    else if (highlightedColumn < 0) {
      highlightedColumn = 0;
    }
   
    if (highlightedRow >= numberOfRows) {
      highlightedRow = numberOfRows - 1;
    }
    else if (highlightedRow < 0) {
      highlightedRow = 0;
    }

    highlightAlbum(highlightedRow, highlightedColumn);
  }

  function pageLoaded() {
    console.log('pageLoaded');
    buildAlbumsTable();
    highlightAlbum(0, 0);
  }

  function buildAlbumsTable() {
    var row;
    var nameCell;
    var photoCountCell;
    var table = document.getElementById("albums");
    var columnIndex = 0;

    row = table.insertRow();
    for (let albumIndex = 0; albumIndex < albums.length; albumIndex++) {

      const album = albums[albumIndex];
      nameCell = row.insertCell(columnIndex);
      nameCell.innerHTML = album.title;

      if (columnIndex === (numColumnsPerRow - 1)) {
        row = table.insertRow();
        columnIndex = 0;
      }
      else {
        columnIndex++;
      }
    }
  }

  function oldbuildAlbumsTable() {
    var row;
    var nameCell;
    var photoCountCell;
    var table = document.getElementById("albums");

    albums.forEach((album) => {
      row = table.insertRow();
      nameCell = row.insertCell(0);
      nameCell.innerHTML = album.title;
      photoCountCell = row.insertCell(1);
      photoCountCell.innerHTML = album.photoCount.toString();
    });
  }

  function highlightAlbum(rowIndex, columnIndex) {

    var table = document.getElementById('albums');

    var albumCells = table.getElementsByTagName('td');
    for (var cellIndex = 0; cellIndex < albumCells.length; cellIndex++) {
      albumCells[cellIndex].style.backgroundColor = "";
      albumCells[cellIndex].classList.remove('selected');
    }

    var selectedCellIndex = (rowIndex * 3) + columnIndex;
    var selectedCell = albumCells[selectedCellIndex];
    selectedCell.style.backgroundColor = "yellow";
    selectedCell.className += " selected";
  }

</script>

</html>